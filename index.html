<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>smarthome</title>
  <script type="text/javascript" src="ajax.js"></script>
  <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>

<script class="code" type="text/javascript">
var now=new Date();
var theDate="";
var windowWidth = null;

var humidity = [];
var humidityPlot = null;
var humidityCounter = 0;

var temperature = [];
var temperaturePlot = null;
var temperatureCounter = 0;


var colors = [];
colors.push({name: "Wohnzimmer", dash: "solid", color: "rgb(234, 153, 153)"});
colors.push({name: "Flur", dash: "solid", color: "rgb(142, 124, 195)"});
colors.push({name: "Bad", dash: "solid", color: "rgb(255, 217, 102)"});
colors.push({name: "Keller", dash: "solid", color: "rgb(164, 194, 244)"});
colors.push({name: "Schlafzimmer", dash: "solid", color: "rgb(219, 64, 82)"});

function updateDate() {
  var month=now.getMonth()+1;
  month=month<10 ? ("0"+month) : month;
  var day=now.getDate();
  day=day<10 ? ("0"+day) : day;
  theDate=now.getFullYear()+"-"+month+"-"+day;
  document.getElementById("dateDiv").innerHTML = theDate;
}

function doParse(data, thename) {
  var myx = [];
  var myy = [];
  var leSplit=data.split("\n");
  var dstring=now.toDateString();
  for(var i=0; i<leSplit.length; i++) {
    var entry = leSplit[i].split(";");
    if (entry.length == 2) {
      myx.push(new Date(dstring+" "+entry[0]));
      myy.push(parseFloat(entry[1]));
    }
  }

  thecolor = {};
  for(var j=0; j<colors.length;j++) {
    thecolor = colors[j];
    if (colors[j]["name"] == thename) {
      break;
    }
  }

  return {x: myx, y: myy, name: thename, line: thecolor};
}

function doTemperaturePlot(temperature) {
  if (temperatureCounter < 1) {
    return;
  }
  temperature = temperature.sort(function(a,b) {return a.name.localeCompare(b.name)});
  temperaturePlot = Plotly.newPlot("temperature", temperature, {title: {text: "Temperatur"}, xaxis: {range:[theDate+" 00:00:00", theDate+" 23:59:59"]}, yaxis: {title: {text: "Temperatur [Â°C]"}}}, {displaylogo: false});
}

function doHumidityPlot(humidity) {
  if (humidityCounter < 1) {
    return;
  }
  humidity = humidity.sort(function(a,b) {return a.name.localeCompare(b.name)});
  humidityPlot = Plotly.newPlot("humidity", humidity, {title: {text: "Luftfeuchtigkeit"}, xaxis: {range:[theDate+" 00:00:00", theDate+" 23:59:59"]}, yaxis: {title: {text: "Luftfeuchtigkeit [%]"}}}, {displaylogo: false});
}

function doPlot() {
  windowWidth=window.innerWidth;

  humidity = [];
  Plotly.purge("humidity");
  humidityCounter = 0;
     doAjax({url: "get.php?date="+theDate+"&sensor=wohnzimmer_humidity", responseType: "text", errorFunction: function() {
       humidityCounter = humidityCounter + 1;
       doHumidityPlot(humidity);
     }, successFunction: function(request){
       humidity.push(doParse(request.response, "Wohnzimmer"));
       humidityCounter = humidityCounter + 1;
       doHumidityPlot(humidity);
     }});


  temperature = [];
  Plotly.purge("temperature")
  temperatureCounter = 0;
     doAjax({url: "get.php?date="+theDate+"&sensor=wohnzimmer_temperature", responseType: "text",
       errorFunction: function() {
       }, successFunction: function(request){
         temperature.push(doParse(request.response, "Wohnzimmer"));
         temperatureCounter = temperatureCounter + 1;
         doTemperaturePlot(temperature);
     }});


}

function left() {
  now.setDate(now.getDate() - 1);
  updateDate();
  doPlot();
}

function right() {
  now.setDate(now.getDate() + 1);
  updateDate();
  doPlot();
}

function refresh() {
  doPlot();
}

function setDateManually() {
 var userDate = window.prompt("Date", theDate);
 var userSplit = userDate.split("-");
 if (userSplit.length != 3) {
  window.alert("invalid input");
  return;
 }
 now.setFullYear(parseInt(userSplit[0]));
 now.setMonth(parseInt(userSplit[1])-1);
 now.setDate(parseInt(userSplit[2]));
 updateDate();
 doPlot();
}

document.addEventListener("DOMContentLoaded", function() {
  document.addEventListener("keydown", function(e) {
      if(e.which == 188) { // ,
        left();
      }
      else if(e.which == 190) { // .
        right();
      }
      else if(e.which == 173) { // -
        doPlot();
      }
    });

  window.addEventListener("resize", function() {
    if (window.innerWidth != windowWidth) {
      doPlot();
    }
  });

  updateDate();
  doPlot();
});
</script>

</head>
<body>

<div style="text-align:center;font-size:20pt;font-weight:bold"><a style="text-decoration:none;font-size:30pt" href="javascript:left()">&larr;</a> <span id="dateDiv" style="cursor:pointer" onClick="javascript:setDateManually()"></span> <a style="text-decoration:none;font-size:20pt" href="javascript:refresh()">&#x21bb;</a> <a style="text-decoration:none;font-size:30pt" href="javascript:right()">&rarr;</a></div>

<div id="humidity"></div>
<div id="temperature"></div>

<p style="color: lightgray;margin-top: 3em;margin-left:1em">smarthome &mdash; &copy;<a href="https://github.com/mtill/bluetooth-hygrometer-reader-tp357" target="_blank" style="text-decoration:none;color: lightgray">mtill</a>, 2017-2025</p>

</body>
</html>

